name: Tag Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0) - leave empty to auto-increment patch'
        required: false
        type: string

permissions:
  contents: write

jobs:
  tag:
    name: Create Tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            # Validate provided version
            if [[ ! "$INPUT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Version must be in format X.Y.Z (e.g., 0.1.0)"
              exit 1
            fi
            echo "VERSION=$INPUT_VERSION" >> $GITHUB_OUTPUT
          else
            # Auto-increment patch version
            LATEST=$(git tag -l 'v*' --sort=-v:refname | head -n1)
            if [ -z "$LATEST" ]; then
              echo "VERSION=0.1.0" >> $GITHUB_OUTPUT
            else
              # Strip 'v' prefix and split
              CURRENT=${LATEST#v}
              MAJOR=$(echo "$CURRENT" | cut -d. -f1)
              MINOR=$(echo "$CURRENT" | cut -d. -f2)
              PATCH=$(echo "$CURRENT" | cut -d. -f3)
              PATCH=$((PATCH + 1))
              echo "VERSION=$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          INPUT_VERSION: ${{ inputs.version }}

      - name: Check tag doesn't exist
        run: |
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$VERSION already exists"
            exit 1
          fi
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "Created tag v$VERSION"
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
